<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Tài Lộc Quá Lớn - Tương tác Mở Bát</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@500;700&display=swap');

        :root {
            --gold-light: #fef4d2;
            --gold-main: #e6a73a;
            --gold-dark: #a16d18;
            --bg-deep: #050811;
            --bg-dark: #0a0f1f;
            --bg-light: #1c2a39;
            --text-light: #fff;
            --text-dark: #000;
            --red: #d92d2d;
            --blue: #2d89d9;
        }

        body {
            font-family: 'Teko', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-light);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px 0;
            background-image: url('https://i.imgur.com/8i2dE7L.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .game-wrapper {
            width: 100%;
            max-width: 1200px;
            background: linear-gradient(180deg, rgba(3, 10, 29, 0.9), rgba(16, 27, 48, 0.9));
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5), 0 0 30px rgba(0,0,0,0.5);
            padding: 10px;
            position: relative;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
        }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .avatar { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            border: 2px solid var(--gold-main);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .avatar:hover {
            transform: scale(1.1);
        }
        .player-name { font-size: 1.5em; font-weight: 700; }
        .balance { font-size: 1.6em; font-weight: 700; color: var(--gold-light); }
        .top-bar-icons { display: flex; gap: 15px; }
        .icon-button { background: none; border: none; cursor: pointer; color: var(--gold-light); font-size: 2em; }

        .main-board {
            background-color: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 10px;
            position: relative;
            border: 1px solid var(--gold-dark);
        }

        .jackpot-area {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .jackpot-logo {
            width: 180px;
            height: 90px;
            background: url('https://i.imgur.com/OiqjT8H.png') no-repeat center center;
            background-size: contain;
        }
        .jackpot-amount {
            background: rgba(0,0,0,0.7);
            color: var(--gold-light);
            font-size: 1.8em;
            padding: 2px 20px;
            border-radius: 20px;
            border: 1px solid var(--gold-main);
            margin-top: -30px;
        }

        .main-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 0 20px 0;
        }

        .betting-area {
            width: 380px;
            height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background-size: 150% 150%;
            transition: transform 0.3s ease;
            border-radius: 20px;
            border: 2px solid;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .tai-area { background-image: linear-gradient(145deg, #d32f2f, #9a0007); border-color: var(--red); }
        .xiu-area { background-image: linear-gradient(145deg, #2979ff, #0d47a1); border-color: var(--blue); }
        .betting-area.win-glow { animation: win-pulse 1.5s infinite; }
        @keyframes win-pulse {
            0% { box-shadow: 0 0 20px 5px var(--gold-light), inset 0 0 20px rgba(0,0,0,0.5); }
            50% { box-shadow: 0 0 40px 15px var(--gold-light), inset 0 0 20px rgba(0,0,0,0.5); }
            100% { box-shadow: 0 0 20px 5px var(--gold-light), inset 0 0 20px rgba(0,0,0,0.5); }
        }

        .bet-title { font-size: 6em; font-weight: 700; text-shadow: 3px 3px 0 #000; line-height: 1; }
        .total-bet-display { font-size: 1.8em; color: var(--text-light); }
        .player-bet-wrapper { text-align: center; margin-top: 5px; }
        .player-bet-display { font-size: 1.5em; color: var(--gold-light); }
        .cancel-bet-button {
            background: none; border: none; color: var(--red); font-size: 1.2em; cursor: pointer;
            text-decoration: underline; display: none;
        }
        .place-bet-button {
            font-family: 'Teko', sans-serif;
            font-size: 2em;
            font-weight: 700;
            color: var(--text-dark);
            background: linear-gradient(180deg, #fef4d2, var(--gold-main));
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            padding: 0px 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--gold-dark), inset 0 2px 5px rgba(255,255,255,0.5);
            transition: all 0.1s ease;
            margin-top: 15px;
        }
        .place-bet-button:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--gold-dark); }
        .place-bet-button:disabled { background: #888; color: #ccc; box-shadow: 0 4px 0 #555; cursor: not-allowed; }

        .center-column { display: flex; flex-direction: column; align-items: center; position: relative; width: 220px; }
        #countdown-timer {
            width: 50px; height: 50px; border-radius: 50%; background: radial-gradient(circle, #333, #000);
            color: var(--gold-light); font-size: 2.5em; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--gold-main); position: absolute; top: 0px; z-index: 10;
        }
        #session-id {
            position: absolute;
            top: 60px;
            background-color: rgba(0,0,0,0.5);
            padding: 0 10px;
            border-radius: 10px;
            font-size: 1.2em;
            color: #ccc;
        }

        .result-display-wrapper {
            width: 200px; 
            height: 200px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            position: relative; 
            margin-top: 80px;
        }
        #result-text { font-size: 4em; font-weight: 900; line-height: 1; margin-top: -20px; }
        #result-sum { font-size: 2em; color: var(--gold-light); }

        .bowl-container {
            width: 200px;
            height: 150px;
            position: absolute;
            top: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .bowl-container.shaking {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        #bowl-cover {
            width: 150px;
            height: 150px;
            background: url('https://i.imgur.com/3g8E7R2.png') no-repeat center center;
            background-size: contain;
            position: absolute;
            top: 0;
            cursor: grab;
            transition: transform 0.3s ease, opacity 0.5s ease;
            z-index: 5;
        }
        #bowl-cover.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #bowl-cover:active {
            cursor: grabbing;
        }
        
        .dice-container { 
            display: flex; 
            gap: 10px; 
            margin-top: 10px;
            min-height: 50px;
        }
        .dice { width: 50px; height: 50px; transition: transform 1s ease-out; }
        .dice.rolling { animation: roll 1s ease-out; }
        @keyframes roll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(720deg) rotateY(720deg); }
        }
        
        .history-bar {
            background-color: rgba(0,0,0,0.4); border-radius: 25px; padding: 8px; margin-top: 20px;
            display: flex; align-items: center; gap: 0; overflow-x: auto; border: 1px solid var(--gold-dark);
        }
        .history-dot {
            width: 30px; height: 30px; font-weight: bold; font-size: 1.5em; display: flex; align-items: center;
            justify-content: center; color: white; flex-shrink: 0; border-right: 1px solid rgba(255,255,255,0.2);
        }
        .history-dot:last-child { border: none; }
        .history-dot.tai { background-color: var(--red); }
        .history-dot.xiu { background-color: var(--blue); }

        .betting-controls { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; padding: 15px 0; gap: 10px; }
        .bet-chip {
            font-family: 'Teko', sans-serif; padding: 5px 25px; font-size: 1.5em; font-weight: 700; border-radius: 25px;
            border: 2px solid var(--gold-main); background: linear-gradient(145deg, #4d3803, #2e2102);
            color: var(--gold-light); cursor: pointer; transition: all 0.2s ease;
        }
        .bet-chip:hover { background: linear-gradient(145deg, var(--gold-light), var(--gold-main)); color: var(--text-dark); }
        .bet-chip:disabled { background: #888; border-color: #555; color: #ccc; cursor: not-allowed; }
        #current-bet-display { font-size: 2em; font-weight: 700; margin: 0 20px; color: var(--gold-light); }
        #clear-bet-button {
            font-family: 'Teko', sans-serif; background: var(--red); color: white; border: none; padding: 5px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.5em;
        }
        #clear-bet-button:disabled { background: #5a5a5a; cursor: not-allowed; }

        .bottom-menu {
            display: flex; justify-content: space-around; margin-top: 10px; padding: 10px;
            background-color: rgba(0,0,0,0.3); border-radius: 15px; border-top: 1px solid var(--gold-dark);
        }
        .menu-button {
            font-family: 'Teko', sans-serif; font-size: 1.5em; background: none; border: none;
            color: var(--gold-light); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .menu-button .icon { width: 28px; height: 28px; margin-bottom: -5px; object-fit: contain; }
        .menu-button.primary {
            background: linear-gradient(180deg, #f8e08e, var(--gold-main)); color: var(--text-dark);
            padding: 5px 30px; border-radius: 10px; border: 2px solid var(--gold-dark);
        }

        /* Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            font-family: 'Teko', sans-serif;
            background: var(--bg-light);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--gold-main);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gold-dark);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 2em;
            color: var(--gold-light);
        }
        .modal-close-button {
            background: var(--red);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }
        .modal-input {
            width: calc(100% - 20px);
            padding: 10px;
            font-size: 1.5em;
            font-family: 'Teko', sans-serif;
            border-radius: 5px;
            border: 2px solid var(--gold-dark);
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin-bottom: 20px;
        }
        .modal-submit-button {
            font-family: 'Teko', sans-serif;
            font-size: 1.8em;
            padding: 8px 40px;
            background: linear-gradient(180deg, #f8e08e, var(--gold-main));
            color: var(--text-dark);
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            cursor: pointer;
        }

        /* Custom Alert Styling */
        #custom-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #custom-alert.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #custom-alert-box {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid var(--gold-main);
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        #custom-alert.visible #custom-alert-box {
            transform: scale(1);
        }
        #custom-alert-message {
            font-size: 2em;
            margin: 0;
            color: var(--gold-light);
        }
        #custom-alert-message.large {
            font-size: 5em;
            font-weight: 900;
            text-shadow: 3px 3px 0 #000;
        }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <div class="top-bar">
            <div class="player-info">
                <img src="https://placehold.co/60x60/1c2a39/fde89a?text=P" alt="Avatar" class="avatar" id="player-avatar">
                <div>
                    <div class="player-name" id="player-name-display">Player123</div>
                    <div class="balance" id="player-balance">0</div>
                </div>
            </div>
            <div class="top-bar-icons">
                <button class="icon-button">?</button>
                <button class="icon-button">⚙️</button>
            </div>
        </div>
        
        <div class="main-board">
            <div class="jackpot-area">
                <div class="jackpot-logo"></div>
                <div class="jackpot-amount">141,686,996</div>
            </div>

            <main class="main-content">
                <div class="betting-area xiu-area">
                    <div class="bet-title">XỈU</div>
                    <div class="total-bet-display" id="total-bet-xiu">0</div>
                    <div class="player-bet-wrapper">
                        <div class="player-bet-display" id="player-bet-xiu">0</div>
                        <button class="cancel-bet-button" data-side="XIU">Hủy</button>
                    </div>
                    <button class="place-bet-button" data-side="XIU">ĐẶT CƯỢC</button>
                </div>

                <div class="center-column">
                    <div id="countdown-timer">20</div>
                    <div id="session-id">#...</div>
                    <div class="result-display-wrapper">
                        <div id="result-text"></div>
                        <div id="result-sum"></div>
                        <div class="bowl-container" id="bowl-container">
                            <div id="bowl-cover"></div>
                        </div>
                    </div>
                    <div class="dice-container"></div>
                </div>

                <div class="betting-area tai-area">
                    <div class="bet-title">TÀI</div>
                    <div class="total-bet-display" id="total-bet-tai">0</div>
                    <div class="player-bet-wrapper">
                        <div class="player-bet-display" id="player-bet-tai">0</div>
                        <button class="cancel-bet-button" data-side="TAI">Hủy</button>
                    </div>
                    <button class="place-bet-button" data-side="TAI">ĐẶT CƯỢC</button>
                </div>
            </main>
            
            <div class="history-bar" id="history-bar"></div>
        </div>
        
        <div class="betting-controls">
            <button class="bet-chip" data-amount="1000">1K</button>
            <button class="bet-chip" data-amount="10000">10K</button>
            <button class="bet-chip" data-amount="50000">50K</button>
            <button class="bet-chip" data-amount="100000">100K</button>
            <button class="bet-chip" data-amount="500000">500K</button>
            <button class="bet-chip" data-amount="1000000">1M</button>
            <div id="current-bet-display">Cược: 0</div>
            <button id="clear-bet-button">Xóa</button>
        </div>

        <footer class="bottom-menu">
            <button class="menu-button">
                <img src="https://i.imgur.com/3ZmP0fL.png" alt="Menu" class="icon" onerror="this.style.display='none'">
                <span>Menu</span>
            </button>
            <button class="menu-button" id="open-giftcode-modal">
                <img src="https://i.imgur.com/Y1gB2bH.png" alt="Giftcode" class="icon" onerror="this.style.display='none'">
                <span>Giftcode</span>
            </button>
            <button class="menu-button">
                <img src="https://i.imgur.com/kYqX0q2.png" alt="BXH" class="icon" onerror="this.style.display='none'">
                <span>BXH</span>
            </button>
            <button class="menu-button" id="withdraw-button">
                <img src="https://i.imgur.com/vHqj2dF.png" alt="Rút Tiền" class="icon" onerror="this.style.display='none'">
                <span>Rút Tiền</span>
            </button>
            <button class="menu-button primary" id="deposit-button">NẠP NGAY</button>
        </footer>
    </div>
    
    <div id="custom-alert">
        <div id="custom-alert-box">
            <p id="custom-alert-message"></p>
        </div>
    </div>

    <!-- RE-ADDED: Giftcode Modal -->
    <div class="modal-overlay" id="giftcode-modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nhập Giftcode</h2>
                <button class="modal-close-button" id="close-giftcode-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="giftcode-input" class="modal-input" placeholder="Nhập code của bạn...">
                <button id="giftcode-submit" class="modal-submit-button">Xác nhận</button>
            </div>
        </div>
    </div>

    <!-- RE-ADDED: Change Name Modal -->
    <div class="modal-overlay" id="change-name-modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Đổi Tên Nhân Vật</h2>
                <button class="modal-close-button" id="close-change-name-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="change-name-input" class="modal-input" placeholder="Nhập tên mới...">
                <button id="change-name-submit" class="modal-submit-button">Xác nhận</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GAME STATE & CONSTANTS ---
            const ROUND_DURATION = 20;
            const BETTING_LOCK_TIME = 3;
            const MAX_HISTORY = 30;
            let playerBalance = 0; 
            let currentBet = 0;
            let betOnTai = 0;
            let betOnXiu = 0;
            let totalBetOnTai = 0; 
            let totalBetOnXiu = 0; 
            let timeLeft = ROUND_DURATION;
            let gameHistory = [];
            let gameInterval, randomBetInterval;
            let secretRolls = []; 
            let isWaitingForReveal = false;
            let sessionId = 12345;
            let autoRevealTimeout;

            // RE-ADDED: Gift Codes
            const giftCodes = new Map([
                ['k20', 20000],
                ['k50', 50000],
                ['k100', 100000],
                ['k200', 200000],
                ['k500', 500000],
                ['free_money', 1000000]
            ]);

            // --- ELEMENT SELECTORS ---
            const balanceDisplay = document.getElementById('player-balance');
            const resultTextDisplay = document.getElementById('result-text');
            const resultSumDisplay = document.getElementById('result-sum');
            const diceContainer = document.querySelector('.dice-container');
            const betChips = document.querySelectorAll('.bet-chip');
            const placeBetButtons = document.querySelectorAll('.place-bet-button');
            const currentBetDisplay = document.getElementById('current-bet-display');
            const clearBetButton = document.getElementById('clear-bet-button');
            const playerBetTaiDisplay = document.getElementById('player-bet-tai');
            const playerBetXiuDisplay = document.getElementById('player-bet-xiu');
            const totalBetTaiDisplay = document.getElementById('total-bet-tai');
            const totalBetXiuDisplay = document.getElementById('total-bet-xiu');
            const countdownTimerDisplay = document.getElementById('countdown-timer');
            const taiArea = document.querySelector('.tai-area');
            const xiuArea = document.querySelector('.xiu-area');
            const historyBar = document.getElementById('history-bar');
            const cancelBetButtons = document.querySelectorAll('.cancel-bet-button');
            const bowlCover = document.getElementById('bowl-cover');
            const bowlContainer = document.getElementById('bowl-container');
            const sessionIdDisplay = document.getElementById('session-id');
            const depositButton = document.getElementById('deposit-button');
            const withdrawButton = document.getElementById('withdraw-button');
            const customAlert = document.getElementById('custom-alert');
            const customAlertMessage = document.getElementById('custom-alert-message');
            
            // RE-ADDED: Modal Selectors
            const giftcodeModalOverlay = document.getElementById('giftcode-modal-overlay');
            const openGiftcodeModalButton = document.getElementById('open-giftcode-modal');
            const closeGiftcodeModalButton = document.getElementById('close-giftcode-modal');
            const giftcodeInput = document.getElementById('giftcode-input');
            const giftcodeSubmitButton = document.getElementById('giftcode-submit');
            const playerAvatar = document.querySelector('.avatar');
            const playerNameDisplay = document.querySelector('.player-name');
            const changeNameModalOverlay = document.getElementById('change-name-modal-overlay');
            const closeChangeNameModalButton = document.getElementById('close-change-name-modal');
            const changeNameInput = document.getElementById('change-name-input');
            const changeNameSubmitButton = document.getElementById('change-name-submit');
            
            // --- UTILITY FUNCTIONS ---
            const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN').format(amount);

            const showAlert = (message, isLarge = false, duration = 0) => {
                customAlertMessage.textContent = message;
                customAlertMessage.classList.toggle('large', isLarge);
                customAlert.classList.add('visible');

                const closeAlert = () => customAlert.classList.remove('visible');

                if (duration > 0) {
                    setTimeout(closeAlert, duration);
                } else {
                    customAlert.onclick = (e) => {
                        if (e.target === customAlert) {
                            closeAlert();
                        }
                    };
                }
            };

            const updateDisplays = () => {
                balanceDisplay.textContent = formatCurrency(playerBalance);
                currentBetDisplay.textContent = `Cược: ${formatCurrency(currentBet)}`;
                playerBetTaiDisplay.textContent = formatCurrency(betOnTai);
                playerBetXiuDisplay.textContent = formatCurrency(betOnXiu);
                totalBetTaiDisplay.textContent = formatCurrency(totalBetOnTai);
                totalBetXiuDisplay.textContent = formatCurrency(totalBetOnXiu);
                sessionIdDisplay.textContent = `#${sessionId}`;

                document.querySelector('.cancel-bet-button[data-side="TAI"]').style.display = betOnTai > 0 ? 'inline' : 'none';
                document.querySelector('.cancel-bet-button[data-side="XIU"]').style.display = betOnXiu > 0 ? 'inline' : 'none';
            };
            
            const setBettingEnabled = (enabled) => {
                const elementsToToggle = document.querySelectorAll('.bet-chip, #clear-bet-button, .place-bet-button, .cancel-bet-button');
                elementsToToggle.forEach(el => {
                    el.disabled = !enabled;
                });
            };

            const updateHistoryBar = () => {
                historyBar.innerHTML = '';
                const recentHistory = gameHistory.slice(-MAX_HISTORY);
                recentHistory.forEach(result => {
                    const dot = document.createElement('div');
                    dot.classList.add('history-dot');
                    if (result.type === 'TÀI') {
                        dot.classList.add('tai');
                        dot.textContent = 'T';
                    } else {
                        dot.classList.add('xiu');
                        dot.textContent = 'X';
                    }
                    historyBar.appendChild(dot);
                });
            };

            // --- DICE LOGIC ---
            const diceSVG = [ `<svg class="dice" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="white"/><circle cx="50" cy="50" r="10" fill="black"/></svg>`, `<svg class="dice" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="white"/><circle cx="25" cy="25" r="10" fill="black"/><circle cx="75" cy="75" r="10" fill="black"/></svg>`, `<svg class="dice" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="white"/><circle cx="25" cy="25" r="10" fill="black"/><circle cx="50" cy="50" r="10" fill="black"/><circle cx="75" cy="75" r="10" fill="black"/></svg>`, `<svg class="dice" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="white"/><circle cx="25" cy="25" r="10" fill="black"/><circle cx="75" cy="25" r="10" fill="black"/><circle cx="25" cy="75" r="10" fill="black"/><circle cx="75" cy="75" r="10" fill="black"/></svg>`, `<svg class="dice" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="white"/><circle cx="25" cy="25" r="10" fill="black"/><circle cx="75" cy="25" r="10" fill="black"/><circle cx="50" cy="50" r="10" fill="black"/><circle cx="25" cy="75" r="10" fill="black"/><circle cx="75" cy="75" r="10" fill="black"/></svg>`, `<svg class="dice" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="white"/><circle cx="25" cy="25" r="10" fill="black"/><circle cx="25" cy="50" r="10" fill="black"/><circle cx="25" cy="75" r="10" fill="black"/><circle cx="75" cy="25" r="10" fill="black"/><circle cx="75" cy="50" r="10" fill="black"/><circle cx="75" cy="75" r="10" fill="black"/></svg>` ];
            
            // --- BETTING LOGIC ---
            betChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    const amount = parseInt(chip.dataset.amount);
                    if (playerBalance >= currentBet + amount) {
                         currentBet += amount;
                         updateDisplays();
                    } else { showAlert("Không đủ số dư!"); }
                });
            });
            clearBetButton.addEventListener('click', () => { currentBet = 0; updateDisplays(); });
            
            placeBetButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    if (currentBet === 0) return;
                    if (playerBalance < currentBet) { showAlert("Lỗi: Số dư không đủ!"); return; }
                    const side = button.dataset.side;
                    playerBalance -= currentBet;
                    if (side === 'TAI') {
                        betOnTai += currentBet;
                        totalBetOnTai += currentBet;
                    } else if (side === 'XIU') {
                        betOnXiu += currentBet;
                        totalBetOnXiu += currentBet;
                    }
                    currentBet = 0;
                    updateDisplays();
                });
            });

            cancelBetButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const side = button.dataset.side;
                    if (side === 'TAI') {
                        playerBalance += betOnTai;
                        totalBetOnTai -= betOnTai;
                        betOnTai = 0;
                    } else if (side === 'XIU') {
                        playerBalance += betOnXiu;
                        totalBetOnXiu -= betOnXiu;
                        betOnXiu = 0;
                    }
                    updateDisplays();
                });
            });

            // --- GAME FLOW & TIMER LOGIC ---
            const startNewRound = () => {
                isWaitingForReveal = false;
                setBettingEnabled(true);
                resultTextDisplay.textContent = '';
                resultSumDisplay.textContent = '';
                bowlCover.classList.add('hidden');
                bowlCover.style.transform = 'translateY(0)';
                diceContainer.innerHTML = ''; 
                timeLeft = ROUND_DURATION;
                sessionId++;
                countdownTimerDisplay.textContent = timeLeft;
                countdownTimerDisplay.style.color = 'var(--gold-light)';
                countdownTimerDisplay.style.display = 'flex';
                
                totalBetOnTai = 0;
                totalBetOnXiu = 0;

                taiArea.classList.remove('win-glow');
                xiuArea.classList.remove('win-glow');
                updateDisplays(); 

                gameInterval = setInterval(() => {
                    timeLeft--;
                    countdownTimerDisplay.textContent = timeLeft;
                    if (timeLeft <= BETTING_LOCK_TIME) {
                        setBettingEnabled(false);
                        countdownTimerDisplay.style.color = 'var(--red)';
                    }
                    if (timeLeft <= 0) {
                        clearInterval(gameInterval);
                        prepareForReveal();
                    }
                }, 1000);
                
                simulateBets(); 
            };

            const prepareForReveal = () => {
                isWaitingForReveal = true;
                countdownTimerDisplay.style.display = 'none';
                resultTextDisplay.textContent = 'Mở bát';
                bowlCover.classList.remove('hidden');
                bowlContainer.classList.add('shaking');
                
                diceContainer.innerHTML = ''; 
                
                secretRolls = [ Math.floor(Math.random() * 6) + 1, Math.floor(Math.random() * 6) + 1, Math.floor(Math.random() * 6) + 1 ];

                setTimeout(() => {
                    bowlContainer.classList.remove('shaking');
                    autoRevealTimeout = setTimeout(() => {
                        if (isWaitingForReveal) {
                            revealBowl(true);
                        }
                    }, 2000);
                }, 500);
            };

            const executeRoll = () => {
                if(secretRolls.length === 0) return;

                const rolls = secretRolls;
                const sum = rolls.reduce((a, b) => a + b, 0);
                
                diceContainer.innerHTML = diceSVG[rolls[0] - 1] + diceSVG[rolls[1] - 1] + diceSVG[rolls[2] - 1];
                const diceElements = diceContainer.querySelectorAll('.dice');
                diceElements.forEach(dice => dice.classList.add('rolling'));

                setTimeout(() => {
                    let result = '';
                    if (sum >= 4 && sum <= 10) {
                        result = 'XỈU';
                        resultTextDisplay.style.color = 'var(--blue)';
                        if (betOnXiu > 0) { playerBalance += betOnXiu * 2; xiuArea.classList.add('win-glow'); }
                    } else if (sum >= 11 && sum <= 17) {
                        result = 'TÀI';
                        resultTextDisplay.style.color = 'var(--red)';
                        if (betOnTai > 0) { playerBalance += betOnTai * 2; taiArea.classList.add('win-glow'); }
                    } else {
                        result = 'BỘ BA';
                        resultTextDisplay.style.color = 'var(--gold-light)';
                    }
                    resultTextDisplay.textContent = result;
                    resultSumDisplay.textContent = sum;
                    gameHistory.push({ type: result, sum: sum });
                    updateHistoryBar();
                    betOnTai = 0; betOnXiu = 0;
                    updateDisplays();
                    setTimeout(startNewRound, 3000);
                }, 1000); 
            };
            
            const revealBowl = (isAuto = false) => {
                if (!isWaitingForReveal) return;
                clearTimeout(autoRevealTimeout);
                isWaitingForReveal = false;
                
                bowlCover.style.transition = 'transform 0.3s ease';
                bowlCover.style.transform = 'translateY(-200px)';
                resultTextDisplay.textContent = '';
                executeRoll();
            };

            // --- BOWL SWIPE LOGIC ---
            let isDragging = false;
            let startY = 0;
            let currentY = 0;

            bowlCover.addEventListener('mousedown', (e) => {
                if (!isWaitingForReveal) return;
                isDragging = true;
                startY = e.clientY;
                bowlCover.style.transition = 'none'; 
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging || !isWaitingForReveal) return;
                currentY = e.clientY - startY;
                if (currentY < 0) { 
                    bowlCover.style.transform = `translateY(${currentY}px)`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (!isDragging || !isWaitingForReveal) return;
                isDragging = false;
                
                if (currentY < -50) { 
                    revealBowl();
                } else { 
                    bowlCover.style.transition = 'transform 0.3s ease';
                    bowlCover.style.transform = 'translateY(0)';
                }
                currentY = 0;
            });
            
            // --- SIMULATE OTHER PLAYERS ---
            const simulateBets = () => {
                clearInterval(randomBetInterval);
                randomBetInterval = setInterval(() => {
                    if (timeLeft > BETTING_LOCK_TIME) {
                        totalBetOnTai += Math.floor(Math.random() * 500000) + 10000;
                        totalBetOnXiu += Math.floor(Math.random() * 500000) + 10000;
                        updateDisplays();
                    } else {
                        clearInterval(randomBetInterval); 
                    }
                }, 700); 
            };

            // --- MENU BUTTON LOGIC ---
            depositButton.addEventListener('click', () => {
                showAlert("Đây chỉ là web demo, đừng nghiện cờ bạc nhé!");
            });

            withdrawButton.addEventListener('click', () => {
                showAlert("CÓ CÁI NỊT", true, 2000);
            });
            
            // RE-ADDED: GIFTCODE MODAL LOGIC
            openGiftcodeModalButton.addEventListener('click', () => {
                giftcodeModalOverlay.classList.add('visible');
            });

            const closeGiftcodeModal = () => {
                giftcodeModalOverlay.classList.remove('visible');
            };

            closeGiftcodeModalButton.addEventListener('click', closeGiftcodeModal);
            giftcodeModalOverlay.addEventListener('click', (e) => {
                if (e.target === giftcodeModalOverlay) {
                    closeGiftcodeModal();
                }
            });

            giftcodeSubmitButton.addEventListener('click', () => {
                const code = giftcodeInput.value.trim().toLowerCase();
                if (giftCodes.has(code)) {
                    const amount = giftCodes.get(code);
                    playerBalance += amount;
                    showAlert(`Chúc mừng! Bạn đã nhận được ${formatCurrency(amount)}.`);
                    giftCodes.delete(code);
                    updateDisplays();
                    closeGiftcodeModal();
                } else {
                    showAlert("Giftcode không hợp lệ hoặc đã được sử dụng!");
                }
                giftcodeInput.value = '';
            });

            // RE-ADDED: CHANGE NAME MODAL LOGIC
            playerAvatar.addEventListener('click', () => {
                changeNameModalOverlay.classList.add('visible');
                changeNameInput.value = playerNameDisplay.textContent;
            });
            
            const closeChangeNameModal = () => {
                changeNameModalOverlay.classList.remove('visible');
            };

            closeChangeNameModalButton.addEventListener('click', closeChangeNameModal);
            changeNameModalOverlay.addEventListener('click', (e) => {
                if (e.target === changeNameModalOverlay) {
                    closeChangeNameModal();
                }
            });

            changeNameSubmitButton.addEventListener('click', () => {
                const newName = changeNameInput.value.trim();
                if (newName) {
                    playerNameDisplay.textContent = newName;
                    closeChangeNameModal();
                } else {
                    showAlert("Tên không được để trống!");
                }
            });

            // --- INITIALIZE GAME ---
            updateDisplays();
            updateHistoryBar();
            startNewRound();
        });
    </script>
</body>
</html>
